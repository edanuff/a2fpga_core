# Simplified Makefile for DOC5503 register testing

# Directory paths
HDLDIR = ../../hdl/sound
SUPPORTDIR = ../../hdl/support

# Build output paths
BUILDDIR = build
OBJDIR = $(BUILDDIR)/obj_dir
OUTPUTDIR = output

# Local directory structure
HARNESSDIR = harness
TESTCASESDIR = testcases
DOC5503DIR = $(TESTCASESDIR)/doc5503

# Make sure build and output directories exist
$(shell mkdir -p $(BUILDDIR) $(OUTPUTDIR))

# Verilator flags
VERILATOR_FLAGS = -Wall -Wno-fatal --trace -CFLAGS "-O3 -g3" --cc --exe
VERILATOR_FLAGS += -I$(HDLDIR) -I$(SUPPORTDIR)

# C++ compiler flags
CXXFLAGS = -std=c++17 -Wall -O3 -g
VERILATOR_INCLUDE = /opt/homebrew/Cellar/verilator/5.034/share/verilator/include

# Source files for DOC register testing
REG_MODULE_SV = $(HARNESSDIR)/doc5503_reg_harness.sv
REG_MODULE_CPP = $(DOC5503DIR)/doc5503_reg_test.cpp
REG_HDLFILES = $(HDLDIR)/doc5503.sv $(SUPPORTDIR)/srff.v

# Create build directory structure
$(shell mkdir -p $(OBJDIR))

# Default target
all: reg_test

# Register test targets
reg_test: $(OBJDIR)/Vdoc5503_reg_harness

$(OBJDIR)/Vdoc5503_reg_harness: $(REG_MODULE_SV) $(REG_MODULE_CPP) $(REG_HDLFILES)
	verilator $(VERILATOR_FLAGS) $(REG_MODULE_SV) $(REG_HDLFILES) $(REG_MODULE_CPP) --top-module doc5503_reg_harness -Mdir $(OBJDIR)
	make -C $(OBJDIR) -f Vdoc5503_reg_harness.mk

# Run targets
run: $(OBJDIR)/Vdoc5503_reg_harness
	cd $(BUILDDIR) && ./obj_dir/Vdoc5503_reg_harness

# Clean targets
clean:
	rm -rf $(BUILDDIR) $(OUTPUTDIR)

.PHONY: all reg_test run clean